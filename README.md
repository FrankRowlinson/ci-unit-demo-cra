# CI домашка

### Локальный запуск

1. Склонировать себе репо
2. `npm i` или `npm ci` (оба варианта подойдут для локальной разработки)

### Как работает CI

[Небольшая блок-схема с основными этапами релиза (outdated в блоке с хотфиксами)](https://i.imgur.com/VZOlYtF.png)

- На локальные коммиты настроен гит-хук, проверяющий имена коммитов согласно conventional commits
  - Работает с помощью хуков от **lefthook** и библиотеки **commitlint**
- На пуш в ремоут настроен автоматический pre-push хук на запуск юнит и e2e тестов в headful режиме
- На pull request в репо настроен автоматический прогон тестов в CI в headless режиме и запрет на merge при неудачном прохождении тестов

- При пуше в master ветку с тегом вида v<число> происходит подготовка релиза (`prepare-release.yml`):

  - От коммита с тегом отводится ветка release-%tag%
  - На этой ветке прогоняются тесты
  - Формируется changelog от текущего тега до предыдущего тега
  - Релиз добавляется в issue с пометкой release со всей необходимой информацией

- При возникновении ошибок на этапе тестирования релиза доступны следующие опции:

  - Если ошибки не критичные, можно запускать процесс деплоя (о нем ниже)
  - Если ошибки признаны недопустимыми, запускается процесс хотфикса:
    - Локально вносятся правки в ветку master
    - С помощью `git cherry-pick` нужные изменения переносятся на релизную ветку и пушатся в репо
    - На пуш в релизную ветку триггерится флоу `process-hotfix.yml`, который заново прогоняет тесты и только в случае их успеха формируется hotfix-changelog, который добавляется как комментарий к issue. Он содержит изменения между HEAD релизной ветки и релизным тегом (то есть все правки)

- Процесс деплоя запускается вручную из вкладки Actions. Для этого нужно перейти в Action `Deploy`, выбрать **последнюю** релизную ветку и запустить с помощью **Run**
  - В этом флоу создается билд релиза и с помощью стороннего экшна пушится в ветку gh-pages
  - С ветки gh-pages настроен автоматический деплой на github-pages в настройках репо
  - После успешного деплоя issue текущего релиза закрывается с комментарием, содержащим ссылку на деплой
